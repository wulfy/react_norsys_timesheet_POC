<!-- template.html -->
<html>
  <head>
    <title>Product stock tutorial</title>
	<link rel="stylesheet" href="test.css">
    <script src="http://fb.me/react-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js"></script>
  </head>
  <body>
   <div id="content"></div>
    <div id="test"></div>
    <script type="text/jsx">
	/* norsys test */
	var numberTestDiv = 100;
	var currentNode = null;
	var USER_DATA = [];
	var CATEGORIES_PROJET = {
	1 : "TMA M6",
	3 : "TMA M6 Replay",
	5 : "AT"
	}
	
	var OPTIONS_DATA = [
	  "I",
	  "C",
	  "SEO",
	  "SCOTTY"
	];
	
	function generate_Random_tasks()
	{
		var task_list = [];
		var random_value;
		var max = OPTIONS_DATA.length-1;
		var min = 0;
		for(var i=0;i<numberTestDiv;i++)
		{
			random_value = Math.floor((Math.random() * max)+min)
			task_list.push(random_value);
		}
		
		return task_list;
	}
	
	function initDatas(){
		var tasks = [];
		tasks=generate_Random_tasks();
		USER_DATA.push({user: {name:'Yannick Gard',id:102}, categorie_projet: 1, taches: tasks});
		tasks=generate_Random_tasks();
		USER_DATA.push({user: {name:'Cécile Aubin',id:244}, categorie_projet: 3, taches: tasks});
		tasks=generate_Random_tasks();
		USER_DATA.push({user: {name:'Thibaud Ringenbach',id:210}, categorie_projet: 1, taches: tasks});
		tasks=generate_Random_tasks();
		USER_DATA.push({user: {name:'Boris Coppin',id:53}, categorie_projet: 5, taches: tasks});
		tasks=generate_Random_tasks();
		USER_DATA.push({user: {name:'Amandine Daigle',id:66}, categorie_projet: 5, taches: tasks});
	
	}
	
	var DaySelectorOption = React.createClass({
		render: function() {
			var selected = this.props.selected ? "selected" : "";
			return (
				<option> {this.props.value}</option>
			);
		}	
	});
	
	var DaySelector = React.createClass({
		handleChange: function(event){
			this.props.onUserSelect(event.target.value);
		  },
		render: function() {
				var options = [];
				//options.push(<option selected> {option}</option>);
				
				this.props.options.forEach(function(option,index) {
							options.push(<option> {option}</option>);
				}.bind(this));				
				return (
					<select className="selectBox" onChange={this.handleChange} value={this.props.selectedOption}>
					{options}
					</select>
				);
		}
	});
	
	function canDisplaySelectBox(element){

		if(currentNode && currentNode != element)
		{
			currentNode.setState({
					valueSaved: currentNode.state.valueSaved,
					displaySelectBox: false
				});
		}else if(element && !element.state.displaySelectBox)
		{
			element.setState({
				valueSaved: element.state.valueSaved,
				displaySelectBox: true
			});
		}
		currentNode = element;
	}
	
	var DayRow = React.createClass({
		getInitialState: function() {
			return {
				valueSaved: this.props.data,
				displaySelectBox: false
			}
		},
		handleUserSelect: function(value) {
			var newValue = (!value)? this.state.valueSaved:value;
			
			//todo => ajax pour sauvegarder sur le serveur
			var refData = this.props.rowId.split("_");
			console.log("Saving data : userId:" + refData[0] + " dayNumber: " + refData[1]  + " Value:" + newValue);
			//si serveur répond ok on modifie la valeur sinon on garde l'ancienne
			//decommenter le if pour simuler une erreur un appel sur 2
			/*if(!(Math.floor((Math.random() * 10))%2 == 0))
			{
				newValue = this.state.valueSaved;
				console.log("erreur");
			}*/
				
			this.setState({
				valueSaved: newValue,
				displaySelectBox: false
			});
			
			
		},
		handleClick: function(e) {
			canDisplaySelectBox(this);
		},
		render: function() {
		console.log("DayRow render");
			var value = this.state.valueSaved;
			if (this.state.displaySelectBox) {
				  value = <DaySelector options={OPTIONS_DATA} selectedOption={this.state.valueSaved} onUserSelect={this.handleUserSelect}  />;
				}
			var classString = "dayRow row " + value;
			return (
				<div className={classString} onClick={this.handleClick}> {value} </div>
			);
		}
	});

	var UserListRow = React.createClass({
		render: function() {
		console.log("UserListRow render");
					var userData = this.props.userData;
					var userId = userData.user.id;
					var dayRowsData = userData.taches;
					var dayRows = [];
					var categorieProjet = userData.categorie_projet;
					var dayRows = dayRowsData.map(function(data, index) {
						userId = userData.user.id+"_"+index; 
						return(<DayRow data={OPTIONS_DATA[data]} rowId={userId}/>)
					});
					return (
						<div>
							<div className="userRow row" > {userData.user.name} </div>
							<div className="categorieRow row" > {CATEGORIES_PROJET[categorieProjet]} </div>
								<div className="dayRowList">
									{dayRows}
								</div>
							<br/>
						</div>
					);
			}
	});
	
	var CreateTestList = React.createClass({
		handleResetSelect: function(e) {
			if(currentNode && (e.target.className.indexOf("dayRow")==-1) && (e.target.className.indexOf("selectBox")==-1))
			{
				canDisplaySelectBox(null);
			}			
		},
		handleSaveData: function(data) {
			
		},
		render: function() {
				var list = USER_DATA.map(function(data, index) {
					return(<UserListRow className="userListRow" userData={data}/>)
				});
				return (
						<div id="list" onClick={this.handleResetSelect} >
							{list}
						</div>
				);
			}
		});
	initDatas();
	React.render(<CreateTestList />, document.getElementById('test'));
	
    </script>
  </body>
</html>